---
phase: 02-interactive-background
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - static/js/flow-field-background.js
  - layouts/_default/baseof.html
  - assets/css/main.css
autonomous: true

must_haves:
  truths:
    - "Animation pauses when browser tab is hidden"
    - "Users with prefers-reduced-motion see static gradient instead of animation"
    - "Mobile devices get fewer particles for smooth performance"
    - "Canvas loads on every page of the site"
  artifacts:
    - path: "static/js/flow-field-background.js"
      provides: "Browser optimizations and accessibility features"
      contains: "visibilitychange"
    - path: "layouts/_default/baseof.html"
      provides: "Script inclusion for animation"
      contains: "flow-field-background.js"
    - path: "assets/css/main.css"
      provides: "Static gradient fallback styles"
      contains: "static-background"
  key_links:
    - from: "layouts/_default/baseof.html"
      to: "static/js/flow-field-background.js"
      via: "script tag"
      pattern: "flow-field-background"
    - from: "static/js/flow-field-background.js"
      to: "assets/css/main.css"
      via: "static-background class toggle"
      pattern: "static-background"
---

<objective>
Add browser optimizations (tab visibility, mobile detection) and accessibility features (reduced-motion fallback) to the flow field animation, then integrate it into the site layout.

Purpose: Ensure the animation is performant across devices, respectful of user preferences, and actually loads on all pages.

Output: Updated animation script with optimizations, CSS fallback gradient, and script integration in baseof.html.
</objective>

<execution_context>
@/home/dan/.claude/get-shit-done/workflows/execute-plan.md
@/home/dan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-interactive-background/02-RESEARCH.md
@.planning/phases/02-interactive-background/02-CONTEXT.md
@.planning/phases/02-interactive-background/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Page Visibility API and mobile detection</name>
  <files>static/js/flow-field-background.js</files>
  <action>
Add these features to the existing flow field script:

1. Page Visibility API (BG-05):
   - Add isAnimating flag
   - Create startAnimation() and stopAnimation() functions
   - Listen to 'visibilitychange' event on document
   - Stop animation when document.hidden is true
   - Resume when visible again

2. Mobile detection and adaptive quality (BG-04):
   - Detect mobile using matchMedia('(pointer: coarse)')
   - Add to CONFIG: mobileParticleCount: 60
   - Use conditional: isMobile ? CONFIG.mobileParticleCount : CONFIG.particleCount
   - Mobile gets larger particles (size 3) for visibility

3. Resize handling:
   - Listen to window resize event
   - Recreate canvas with new dimensions
   - Reinitialize particles (reposition within new bounds)
   - Debounce resize handler (100ms) to avoid excessive calls

Place these additions after the existing code but before the initialization block.
  </action>
  <verify>
Script contains:
- 'visibilitychange' event listener
- 'pointer: coarse' media query check
- window resize event listener
- startAnimation and stopAnimation functions
  </verify>
  <done>Animation pauses on tab switch, adapts particle count for mobile, handles window resize</done>
</task>

<task type="auto">
  <name>Task 2: Add prefers-reduced-motion support with static fallback</name>
  <files>static/js/flow-field-background.js, assets/css/main.css</files>
  <action>
1. In flow-field-background.js, add reduced-motion detection:

At initialization, before creating canvas:
- Check matchMedia('(prefers-reduced-motion: reduce)')
- If matches: don't create canvas, add 'static-background' class to body, return early
- Listen for preference changes and toggle between animation/static

2. In assets/css/main.css, add the static gradient fallback:

```css
/* Reduced motion fallback - static gradient background */
body.static-background::before {
  content: '';
  position: fixed;
  inset: 0;
  background: linear-gradient(
    135deg,
    rgba(99, 102, 241, 0.03) 0%,
    rgba(139, 92, 246, 0.05) 50%,
    rgba(99, 102, 241, 0.03) 100%
  );
  z-index: -1;
  pointer-events: none;
}

.dark body.static-background::before,
body.static-background.dark::before {
  background: linear-gradient(
    135deg,
    rgba(99, 102, 241, 0.08) 0%,
    rgba(139, 92, 246, 0.1) 50%,
    rgba(99, 102, 241, 0.08) 100%
  );
}
```

Use very subtle opacity (0.03-0.05 light, 0.08-0.1 dark) to maintain visual interest without motion. Colors: indigo-500 (#6366f1) and violet-500 (#8b5cf6) to match particle color.
  </action>
  <verify>
- flow-field-background.js contains 'prefers-reduced-motion'
- assets/css/main.css contains '.static-background::before'
- Both light and dark mode gradients defined
  </verify>
  <done>Users with reduced-motion preference see static gradient, preference changes are detected</done>
</task>

<task type="auto">
  <name>Task 3: Integrate animation into site layout</name>
  <files>layouts/_default/baseof.html</files>
  <action>
Add script tags to load the animation on every page.

Before the closing </body> tag (after the scripts.html partial), add:

```html
<!-- Flow Field Background Animation -->
<script src="/js/perlin.js"></script>
<script src="/js/flow-field-background.js"></script>
```

Scripts load after page content for better perceived performance. The animation initializes on DOMContentLoaded which has already fired by this point, so it starts immediately.
  </action>
  <verify>
baseof.html contains script tags for both perlin.js and flow-field-background.js
  </verify>
  <done>Animation loads on all pages that use baseof.html template</done>
</task>

</tasks>

<verification>
1. Open site in browser - animation should run
2. Switch to another tab and back - animation should pause/resume
3. Enable "Reduce motion" in system preferences - should show gradient instead
4. Resize browser window - canvas should adapt
5. Open on mobile or use DevTools mobile emulation - should have fewer, larger particles
</verification>

<success_criteria>
- Animation pauses when tab is not visible (check with console.log or DevTools)
- prefers-reduced-motion users see subtle gradient background
- Mobile devices render 60 particles instead of 150
- Canvas resizes properly when window is resized
- Animation loads on home page and all blog posts
</success_criteria>

<output>
After completion, create `.planning/phases/02-interactive-background/02-02-SUMMARY.md`
</output>
